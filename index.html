<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>POT Buyback Portal</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <meta
      name="description"
      content="Sell POT directly for USDT on BNB Smart Chain (BEP-20) via the official buyback contract."
    />

    <!-- Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }

      :root {
        --bg-main: #050816;
        --bg-card: #0b1020;
        --bg-card-soft: #11172b;
        --accent-green: #28c76f;
        --accent-red: #ff4d4f;
        --accent-blue: #4e7fff;
        --accent-yellow: #ffbf40;
        --text-main: #ffffff;
        --text-sub: #a4b1d1;
        --chip-bg: #151b30;
        --border-soft: #262d45;
        --shadow-soft: 0 24px 60px rgba(0, 0, 0, 0.65);
        --radius-xl: 24px;
        --radius-lg: 16px;
        --radius-pill: 999px;
        --transition-fast: 0.18s ease-out;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #111827 0, #020617 50%, #000 100%);
        color: var(--text-main);
        min-height: 100vh;
      }

      body {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 16px;
      }

      .app-shell {
        width: 100%;
        max-width: 480px;
        background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
        border-radius: 32px;
        padding: 18px 18px 24px;
        box-shadow: var(--shadow-soft);
        border: 1px solid rgba(148, 163, 184, 0.28);
        position: relative;
        overflow: hidden;
      }

      .glow-ring {
        position: absolute;
        inset: -40%;
        background: radial-gradient(circle at 0 0, rgba(56, 189, 248, 0.08), transparent 55%),
          radial-gradient(circle at 100% 0, rgba(52, 211, 153, 0.08), transparent 55%);
        opacity: 0.8;
        pointer-events: none;
      }

      .content {
        position: relative;
        z-index: 1;
      }

      .header {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 18px;
      }

      .logo-wrap {
        width: 64px;
        height: 64px;
        border-radius: 20px;
        padding: 2px;
        background: conic-gradient(
          from 210deg,
          #facc15,
          #22c55e,
          #06b6d4,
          #6366f1,
          #f97316,
          #facc15
        );
        box-shadow: 0 0 16px rgba(250, 204, 21, 0.35);
        flex-shrink: 0;
      }

      .logo-inner {
        width: 100%;
        height: 100%;
        border-radius: 18px;
        background: radial-gradient(circle at 30% 0, #1f2937 0, #020617 55%, #020617 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      .logo-inner img {
        width: 78%;
        height: 78%;
        object-fit: contain;
        display: block;
      }

      .header-text {
        flex: 1;
      }

      .title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .title-main {
        font-size: 1.25rem;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .chip-project {
        padding: 4px 10px;
        border-radius: 999px;
        background: linear-gradient(90deg, #2563eb, #22c55e);
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.11em;
        white-space: nowrap;
      }

      .subtitle {
        font-size: 0.78rem;
        color: var(--text-sub);
        margin-top: 4px;
      }

      .mode-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.7rem;
        margin-top: 6px;
        padding: 3px 9px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.35);
        color: #e5e7eb;
      }

      .mode-dot {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: var(--accent-green);
      }

      .top-bar {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 14px;
      }

      .status-pill {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(31, 41, 55, 0.95);
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.16em;
      }

      .status-pill-label {
        color: #9ca3af;
      }

      .status-pill-value {
        font-weight: 600;
      }

      .dot-online {
        width: 8px;
        height: 8px;
        border-radius: 999px;
        background: var(--accent-red);
        box-shadow: 0 0 0 4px rgba(248, 113, 113, 0.18);
      }

      .dot-online.ok {
        background: var(--accent-green);
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
      }

      .card-main {
        border-radius: var(--radius-xl);
        background: radial-gradient(circle at top left, #111827 0, #020617 55%, #020617 100%);
        border: 1px solid var(--border-soft);
        padding: 16px 14px 18px;
      }

      .card-section {
        border-radius: var(--radius-lg);
        background: radial-gradient(circle at top, #020617 0, #020617 60%, #020617 100%);
        border: 1px solid rgba(31, 41, 55, 0.9);
        padding: 12px 12px 14px;
        margin-bottom: 12px;
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 8px;
      }

      .section-title {
        font-size: 0.76rem;
        letter-spacing: 0.16em;
        text-transform: uppercase;
        color: #9ca3af;
      }

      .section-sub {
        font-size: 0.72rem;
        color: var(--text-sub);
      }

      .network-pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: var(--radius-pill);
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(55, 65, 81, 0.9);
        font-size: 0.7rem;
        white-space: nowrap;
      }

      .network-pill-chain {
        font-weight: 600;
      }

      .address-box {
        font-family: "SF Mono", ui-monospace, Menlo, SFMono-Regular, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.78rem;
        padding: 8px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(31, 41, 55, 0.95);
        color: var(--text-sub);
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 10px;
      }

      .address-main {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .btn {
        border: none;
        outline: none;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.82rem;
        font-weight: 600;
        padding: 10px 10px;
        border-radius: var(--radius-pill);
        transition: transform var(--transition-fast),
          box-shadow var(--transition-fast),
          background var(--transition-fast),
          opacity var(--transition-fast);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        width: 100%;
      }

      .btn-primary {
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: #0b1120;
        box-shadow: 0 10px 30px rgba(34, 197, 94, 0.38);
      }

      .btn-primary:active {
        transform: translateY(1px);
        box-shadow: 0 6px 18px rgba(34, 197, 94, 0.35);
      }

      .btn-outline {
        background: transparent;
        border: 1px solid rgba(75, 85, 99, 0.9);
        color: #e5e7eb;
      }

      .btn[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
        box-shadow: none;
      }

      .btn-row {
        display: flex;
        gap: 8px;
        margin-bottom: 6px;
      }

      .amount-row {
        margin-top: 4px;
      }

      .quick-percent-row {
        display: flex;
        gap: 6px;
        margin-bottom: 6px;
      }

      .quick-percent {
        flex: 1;
        padding: 6px 0;
        border-radius: var(--radius-pill);
        border: 1px solid rgba(55, 65, 81, 0.9);
        background: rgba(15, 23, 42, 0.95);
        color: #e5e7eb;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background var(--transition-fast),
          border-color var(--transition-fast), transform var(--transition-fast),
          box-shadow var(--transition-fast);
      }

      .quick-percent.active {
        background: rgba(34, 197, 94, 0.1);
        border-color: #22c55e;
        box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
      }

      .quick-percent:active {
        transform: translateY(1px);
      }

      .input-group {
        display: flex;
        align-items: stretch;
        border-radius: var(--radius-pill);
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(31, 41, 55, 0.95);
        overflow: hidden;
      }

      .amount-input {
        flex: 1;
        padding: 10px 12px;
        border: none;
        outline: none;
        background: transparent;
        color: #e5e7eb;
        font-size: 0.9rem;
      }

      .amount-input::placeholder {
        color: #4b5563;
      }

      .token-pill {
        padding: 0 14px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border-left: 1px solid rgba(55, 65, 81, 0.9);
        background: radial-gradient(circle at top, #1f2937 0, #020617 75%);
        font-size: 0.8rem;
      }

      .token-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--accent-yellow);
        box-shadow: 0 0 0 4px rgba(250, 204, 21, 0.16);
      }

      .label-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 4px;
      }

      .label-main {
        font-size: 0.76rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: #9ca3af;
      }

      .label-balance {
        font-size: 0.76rem;
        color: var(--text-sub);
      }

      .info-grid {
        display: grid;
        grid-template-columns: 1.1fr 1fr;
        gap: 8px;
        margin-top: 8px;
        margin-bottom: 10px;
      }

      .info-box {
        border-radius: var(--radius-lg);
        padding: 8px 10px;
        background: rgba(15, 23, 42, 0.96);
        border: 1px solid rgba(31, 41, 55, 0.95);
        min-height: 48px;
      }

      .label-small {
        font-size: 0.72rem;
        color: #9ca3af;
        margin-bottom: 4px;
      }

      .value-main {
        font-size: 0.9rem;
        font-weight: 600;
      }

      .value-sub {
        font-size: 0.76rem;
        color: var(--text-sub);
      }

      .status-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-top: 6px;
        margin-bottom: 10px;
      }

      .status-chip {
        border-radius: var(--radius-lg);
        padding: 6px 9px;
        background: rgba(15, 23, 42, 0.96);
        border: 1px dashed rgba(55, 65, 81, 0.9);
        font-size: 0.72rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .status-chip-label {
        color: #9ca3af;
      }

      .status-chip-value {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-weight: 600;
      }

      .status-dot-small {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: var(--accent-red);
      }

      .status-dot-small.ok {
        background: var(--accent-green);
      }

      .primary-action {
        margin-top: 4px;
        margin-bottom: 4px;
      }

      .helper-text {
        font-size: 0.76rem;
        color: #f97373;
        text-align: center;
        margin-top: 4px;
        min-height: 26px;
        word-break: break-word;
      }

      .helper-text.ok {
        color: #22c55e;
      }

      .helper-text.muted {
        color: var(--text-sub);
      }

      .footer {
        margin-top: 10px;
      }

      .footer-section {
        border-radius: var(--radius-lg);
        border: 1px solid rgba(30, 64, 175, 0.6);
        background: radial-gradient(circle at top left, #111827 0, #020617 70%);
        padding: 10px 11px;
        margin-bottom: 8px;
      }

      .footer-title {
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .footer-text {
        font-size: 0.72rem;
        color: var(--text-sub);
        line-height: 1.4;
      }

      .footer-link {
        font-family: "SF Mono", ui-monospace, Menlo, SFMono-Regular, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 0.7rem;
        color: #93c5fd;
        word-break: break-all;
      }

      @media (max-width: 480px) {
        .app-shell {
          border-radius: 20px;
          padding: 14px 14px 18px;
        }

        .header {
          gap: 10px;
        }

        .logo-wrap {
          width: 56px;
          height: 56px;
          border-radius: 18px;
        }

        .title-main {
          font-size: 1.1rem;
        }

        .card-main {
          padding: 12px 10px 14px;
        }
      }
    </style>
  </head>

  <body>
    <div class="app-shell">
      <div class="glow-ring"></div>
      <div class="content">
        <header class="header">
          <div class="logo-wrap">
            <div class="logo-inner">
              <img src="./panda-logo.png" alt="Panda logo" />
            </div>
          </div>
          <div class="header-text">
            <div class="title-row">
              <div>
                <div class="title-main">POT Buyback Portal</div>
              </div>
              <div class="chip-project">Playtopia Organization Token</div>
            </div>
            <div class="subtitle">Sell POT directly for USDT on BNB Smart Chain.</div>
            <div class="mode-pill">
              <span class="mode-dot"></span>
              <span>Direct contract buyback</span>
            </div>
          </div>
        </header>

        <div class="top-bar">
          <div class="status-pill" id="walletStatusPill">
            <span class="dot-online" id="walletDot"></span>
            <span class="status-pill-label">Wallet</span>
            <span class="status-pill-value" id="walletStatusLabel">Disconnected</span>
          </div>
          <div class="status-pill" id="networkStatusPill">
            <span class="dot-online" id="networkDot"></span>
            <span class="status-pill-label">Network</span>
            <span class="status-pill-value" id="networkStatusLabel">
              Unknown (–)
            </span>
          </div>
        </div>

        <main class="card-main">
          <!-- Wallet section -->
          <section class="card-section">
            <div class="section-header">
              <div>
                <div class="section-title">Wallet</div>
                <div class="section-sub">Chain: BNB Smart Chain · BEP-20</div>
              </div>
              <div class="network-pill" id="networkShortLabel">
                <span class="status-dot-small" id="networkShortDot"></span>
                <span class="network-pill-chain">Unknown</span>
              </div>
            </div>

            <div class="address-box" id="addressBox">
              <span class="address-main" id="addressText">Address not connected</span>
            </div>

            <div class="btn-row">
              <button class="btn btn-primary" id="connectButton">
                Connect Wallet
              </button>
              <button class="btn btn-outline" id="disconnectButton" disabled>
                Disconnect
              </button>
            </div>
          </section>

          <!-- Amount section -->
          <section class="card-section amount-row">
            <div class="label-row">
              <div class="label-main">Amount of POT to sell</div>
              <div class="label-balance">
                Balance: <span id="potBalance">– POT</span>
              </div>
            </div>

            <div class="quick-percent-row">
              <button class="quick-percent" data-percent="25">25%</button>
              <button class="quick-percent" data-percent="50">50%</button>
              <button class="quick-percent" data-percent="75">75%</button>
              <button class="quick-percent" data-percent="100">100%</button>
            </div>

            <div class="input-group">
              <input
                id="amountInput"
                class="amount-input"
                type="number"
                inputmode="decimal"
                min="0"
                step="any"
                placeholder="e.g. 1000"
              />
              <div class="token-pill">
                <span class="token-dot"></span>
                <span>POT</span>
              </div>
            </div>

            <div class="info-grid">
              <div class="info-box">
                <div class="label-small">Buyback price</div>
                <div class="value-main" id="pricePerPot">Loading...</div>
                <div class="value-sub" id="priceExtra">–</div>
              </div>
              <div class="info-box">
                <div class="label-small">Estimated receive</div>
                <div class="value-main" id="estimatedReceive">– USDT</div>
                <div class="value-sub" id="estimatedExtra">Fees not included</div>
              </div>
            </div>

            <div class="status-row">
              <div class="status-chip">
                <span class="status-chip-label">Wallet status</span>
                <span class="status-chip-value" id="walletStatusChip">
                  <span class="status-dot-small" id="walletStatusChipDot"></span>
                  <span id="walletStatusChipText">Disconnected</span>
                </span>
              </div>
              <div class="status-chip">
                <span class="status-chip-label">Network status</span>
                <span class="status-chip-value" id="networkStatusChip">
                  <span class="status-dot-small" id="networkStatusChipDot"></span>
                  <span id="networkStatusChipText">Unknown</span>
                </span>
              </div>
            </div>

            <div class="primary-action">
              <button class="btn btn-primary" id="sellButton" disabled>
                Sell POT for USDT
              </button>
            </div>

            <div class="helper-text" id="helperText">
              Connect your wallet to start.
            </div>
          </section>

          <!-- Footer info -->
          <div class="footer">
            <div class="footer-section">
              <div class="footer-title">How it works</div>
              <div class="footer-text">
                1. Connect your wallet on <strong>BNB Smart Chain</strong> (chain 56).<br />
                2. Enter the amount of POT or use quick percentage buttons.<br />
                3. Confirm <strong>approval</strong> on the POT token (first time), then
                confirm the <strong>sell</strong> transaction.<br />
                You will receive BEP-20 USDT from the buyback contract liquidity,
                directly into your wallet.
              </div>
            </div>

            <div class="footer-section">
              <div class="footer-title">Safety checks</div>
              <div class="footer-text">
                Buyback contract (read-only, for payout and price):
              </div>
              <div class="footer-link">
                0x9652CC7355C759DB295E8bd5A21d4D707FC07085
              </div>
              <div class="footer-text" style="margin-top: 4px">
                POT token contract:
              </div>
              <div class="footer-link">
                0x66059443da552aAe6a032E3a84307E6BBbd3cd01
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      // ============ CONFIG ============

      const BSC_CHAIN_ID_HEX = "0x38"; // 56
      const BSC_CHAIN_PARAMS = {
        chainId: BSC_CHAIN_ID_HEX,
        chainName: "BNB Smart Chain",
        nativeCurrency: {
          name: "BNB",
          symbol: "BNB",
          decimals: 18,
        },
        rpcUrls: ["https://bsc-dataseed.binance.org"],
        blockExplorerUrls: ["https://bscscan.com"],
      };

      const POT_TOKEN_ADDRESS = "0x66059443da552aAe6a032E3a84307E6BBbd3cd01";
      const BUYBACK_CONTRACT_ADDRESS = "0x9652CC7355C759DB295E8bd5A21d4D707FC07085";
      const USDT_DECIMALS = 18;
      const POT_DECIMALS = 18;

      const ERC20_ABI = [
        "function balanceOf(address owner) view returns (uint256)",
        "function allowance(address owner, address spender) view returns (uint256)",
        "function approve(address spender, uint256 amount) returns (bool)",
        "function decimals() view returns (uint8)",
      ];

      const BUYBACK_ABI = [
        "function price() view returns (uint256)",
        "function sellTokens(uint256 amount) returns (bool)",
        "function token() view returns (address)",
        "function usdt() view returns (address)",
      ];

      // ============ STATE ============

      let provider = null;
      let ethersProvider = null;
      let signer = null;
      let userAddress = null;

      let potContract = null;
      let buybackContract = null;

      let currentPrice = null;
      let isConnecting = false;
      let isSelling = false;

      // ============ DOM ============

      const connectButton = document.getElementById("connectButton");
      const disconnectButton = document.getElementById("disconnectButton");
      const sellButton = document.getElementById("sellButton");
      const amountInput = document.getElementById("amountInput");
      const percentButtons = document.querySelectorAll(".quick-percent");

      const walletStatusPill = document.getElementById("walletStatusPill");
      const walletDot = document.getElementById("walletDot");
      const walletStatusLabel = document.getElementById("walletStatusLabel");

      const networkStatusPill = document.getElementById("networkStatusPill");
      const networkDot = document.getElementById("networkDot");
      const networkStatusLabel = document.getElementById("networkStatusLabel");

      const addressText = document.getElementById("addressText");
      const potBalanceEl = document.getElementById("potBalance");
      const pricePerPotEl = document.getElementById("pricePerPot");
      const priceExtraEl = document.getElementById("priceExtra");
      const estimatedReceiveEl = document.getElementById("estimatedReceive");
      const estimatedExtraEl = document.getElementById("estimatedExtra");
      const helperText = document.getElementById("helperText");

      const walletStatusChipDot = document.getElementById("walletStatusChipDot");
      const walletStatusChipText = document.getElementById("walletStatusChipText");
      const networkStatusChipDot = document.getElementById("networkStatusChipDot");
      const networkStatusChipText = document.getElementById("networkStatusChipText");

      const networkShortLabel = document.getElementById("networkShortLabel");
      const networkShortDot = document.getElementById("networkShortDot");
      const networkShortLabelText = networkShortLabel.querySelector(".network-pill-chain");

      // ============ HELPERS ============

      function truncateAddress(addr) {
        if (!addr) return "Address not connected";
        return addr.slice(0, 6) + "..." + addr.slice(-4);
      }

      function formatNumber(value, decimals = 4) {
        if (value === null || value === undefined || isNaN(value)) return "–";
        const num = Number(value);
        if (!isFinite(num)) return "–";
        if (num === 0) return "0";
        if (num < 0.0001) return num.toExponential(2);
        return num.toLocaleString(undefined, {
          minimumFractionDigits: 0,
          maximumFractionDigits: decimals,
        });
      }

      function extractErrorMessage(err) {
        if (!err) return "Unknown error";
        if (err.data && err.data.message) return err.data.message;
        if (err.error && err.error.message) return err.error.message;
        if (err.message) return err.message;
        return String(err);
      }

      function setHelperMessage(message, type = "error") {
        helperText.textContent = message || "";
        helperText.classList.remove("ok", "muted");
        if (type === "ok") helperText.classList.add("ok");
        if (type === "muted") helperText.classList.add("muted");
      }

      function setWalletUIConnected(address) {
        walletDot.classList.add("ok");
        walletStatusPill.style.borderColor = "rgba(34,197,94,0.75)";
        walletStatusLabel.textContent = "Connected";

        walletStatusChipDot.classList.add("ok");
        walletStatusChipText.textContent = "Connected";

        addressText.textContent = truncateAddress(address);
        connectButton.textContent = "Wallet Connected";
        connectButton.disabled = true;
        disconnectButton.disabled = false;
      }

      function setWalletUIDisconnected() {
        walletDot.classList.remove("ok");
        walletStatusPill.style.borderColor = "rgba(31,41,55,0.95)";
        walletStatusLabel.textContent = "Disconnected";

        walletStatusChipDot.classList.remove("ok");
        walletStatusChipText.textContent = "Disconnected";

        addressText.textContent = "Address not connected";
        connectButton.textContent = "Connect Wallet";
        connectButton.disabled = false;
        disconnectButton.disabled = true;
        potBalanceEl.textContent = "– POT";
      }

      function setNetworkUI(chainIdHex) {
        if (!chainIdHex) {
          networkDot.classList.remove("ok");
          networkStatusLabel.textContent = "Unknown (–)";
          networkStatusChipDot.classList.remove("ok");
          networkStatusChipText.textContent = "Unknown";
          networkShortDot.classList.remove("ok");
          networkShortLabelText.textContent = "Unknown";
          return;
        }

        if (chainIdHex.toLowerCase() === BSC_CHAIN_ID_HEX.toLowerCase()) {
          networkDot.classList.add("ok");
          networkStatusLabel.textContent = "BNB Smart Chain (56)";
          networkStatusChipDot.classList.add("ok");
          networkStatusChipText.textContent = "BNB Smart Chain";
          networkShortDot.classList.add("ok");
          networkShortLabelText.textContent = "BSC · 56";
        } else {
          networkDot.classList.remove("ok");
          networkStatusLabel.textContent = "Wrong network";
          networkStatusChipDot.classList.remove("ok");
          networkStatusChipText.textContent = "Wrong network";
          networkShortDot.classList.remove("ok");
          networkShortLabelText.textContent = "Unknown";
        }
      }

      function getInjectedProvider() {
        if (window.ethereum) return window.ethereum;
        if (window.trustwallet) return window.trustwallet;
        if (window.BinanceChain) return window.BinanceChain;
        return null;
      }

      function setSellButtonState() {
        if (!userAddress || !currentPrice) {
          sellButton.disabled = true;
          return;
        }
        const raw = amountInput.value.trim();
        if (!raw || Number(raw) <= 0) {
          sellButton.disabled = true;
          return;
        }
        sellButton.disabled = false;
      }

      // ============ WALLET FLOW ============

      async function connectWalletFlow() {
        if (isConnecting) return;
        isConnecting = true;
        setHelperMessage("Connecting wallet...", "muted");

        try {
          provider = getInjectedProvider();
          if (!provider) {
            setHelperMessage(
              "No Web3 wallet detected. Use MetaMask or Trust Wallet in the DApp browser.",
              "error"
            );
            return;
          }

          if (provider.providers && Array.isArray(provider.providers)) {
            const metamaskProvider = provider.providers.find((p) => p.isMetaMask);
            if (metamaskProvider) {
              provider = metamaskProvider;
            }
          }

          // Request accounts with fallback
          let accounts = [];
          try {
            accounts = await provider.request({
              method: "eth_requestAccounts",
            });
          } catch (err) {
            console.warn("eth_requestAccounts failed, trying fallback", err);
            try {
              accounts = await provider.request({
                method: "eth_accounts",
              });
            } catch (err2) {
              console.warn("eth_accounts fallback failed", err2);
              throw err;
            }
          }

          if (!accounts || !accounts.length) {
            setHelperMessage("No accounts returned from wallet.", "error");
            return;
          }

          userAddress = ethers.utils.getAddress(accounts[0]);

          let chainId = null;
          try {
            chainId = await provider.request({ method: "eth_chainId" });
          } catch (err) {
            console.warn("Failed to read chainId", err);
          }

          ethersProvider = new ethers.providers.Web3Provider(provider, "any");
          signer = ethersProvider.getSigner();

          potContract = new ethers.Contract(POT_TOKEN_ADDRESS, ERC20_ABI, signer);
          buybackContract = new ethers.Contract(
            BUYBACK_CONTRACT_ADDRESS,
            BUYBACK_ABI,
            signer
          );

          setWalletUIConnected(userAddress);
          setNetworkUI(chainId);
          setHelperMessage("Wallet connected. If needed, switch to BSC (56) in your wallet.", "ok");

          await refreshBalance();
          await refreshPrice();
          updateEstimate();

          if (!chainId || chainId.toLowerCase() !== BSC_CHAIN_ID_HEX.toLowerCase()) {
            try {
              await provider.request({
                method: "wallet_switchEthereumChain",
                params: [{ chainId: BSC_CHAIN_ID_HEX }],
              });
              const newChainId = await provider.request({ method: "eth_chainId" });
              setNetworkUI(newChainId);
              setHelperMessage("Switched to BNB Smart Chain.", "ok");
            } catch (switchError) {
              console.warn("Network switch failed or rejected", switchError);
              if (switchError && switchError.code === 4902) {
                try {
                  await provider.request({
                    method: "wallet_addEthereumChain",
                    params: [BSC_CHAIN_PARAMS],
                  });
                  const newChainId = await provider.request({ method: "eth_chainId" });
                  setNetworkUI(newChainId);
                  setHelperMessage(
                    "BNB Smart Chain added. Please approve in your wallet.",
                    "ok"
                  );
                } catch (addErr) {
                  console.warn("Add chain rejected", addErr);
                }
              } else {
                setHelperMessage(
                  "Wallet connected. Please switch to BNB Smart Chain (56) inside your wallet.",
                  "error"
                );
              }
            }
          }

          attachProviderListeners();
        } catch (err) {
          console.error("Failed to connect wallet", err);
          setHelperMessage("Failed to connect wallet: " + extractErrorMessage(err), "error");
          setWalletUIDisconnected();
        } finally {
          isConnecting = false;
          setSellButtonState();
        }
      }

      function attachProviderListeners() {
        if (!provider || !provider.on) return;

        if (provider.removeAllListeners) {
          try {
            provider.removeAllListeners("accountsChanged");
            provider.removeAllListeners("chainChanged");
          } catch (e) {
            console.warn("removeAllListeners not supported", e);
          }
        }

        provider.on("accountsChanged", (accounts) => {
          if (!accounts || !accounts.length) {
            userAddress = null;
            setWalletUIDisconnected();
            setNetworkUI(null);
            setHelperMessage("Wallet disconnected.", "muted");
            setSellButtonState();
            return;
          }
          userAddress = ethers.utils.getAddress(accounts[0]);
          setWalletUIConnected(userAddress);
          addressText.textContent = truncateAddress(userAddress);
          refreshBalance();
          setSellButtonState();
        });

        provider.on("chainChanged", (chainId) => {
          setNetworkUI(chainId);
          refreshPrice();
          updateEstimate();
        });
      }

      async function refreshBalance() {
        if (!potContract || !userAddress) return;
        try {
          const balRaw = await potContract.balanceOf(userAddress);
          const bal = Number(ethers.utils.formatUnits(balRaw, POT_DECIMALS));
          potBalanceEl.textContent = `${formatNumber(bal, 4)} POT`;
        } catch (err) {
          console.warn("Failed to load POT balance", err);
          potBalanceEl.textContent = "– POT";
        }
      }

      async function refreshPrice() {
        if (!buybackContract) return;

        pricePerPotEl.textContent = "Loading...";
        priceExtraEl.textContent = "—";

        try {
          const rawPrice = await buybackContract.price();
          currentPrice = rawPrice;

          const priceFloat = Number(
            ethers.utils.formatUnits(rawPrice, USDT_DECIMALS)
          );

          pricePerPotEl.textContent = `${formatNumber(priceFloat, 6)} USDT per POT`;
          priceExtraEl.textContent = "Price from buyback contract";
        } catch (err) {
          console.error("Failed to load price from contract", err);
          currentPrice = null;
          pricePerPotEl.textContent = "Error loading price";
          priceExtraEl.textContent = "Check contract or RPC";
        }
        setSellButtonState();
      }

      function updateEstimate() {
        if (!currentPrice) {
          estimatedReceiveEl.textContent = "– USDT";
          estimatedExtraEl.textContent = "Price not available";
          return;
        }

        const raw = amountInput.value.trim();
        if (!raw || Number(raw) <= 0) {
          estimatedReceiveEl.textContent = "– USDT";
          estimatedExtraEl.textContent = "Enter POT amount";
          return;
        }

        try {
          const amountPOT = ethers.utils.parseUnits(raw, POT_DECIMALS);
          const usdt = amountPOT.mul(currentPrice).div(
            ethers.BigNumber.from(10).pow(POT_DECIMALS)
          );
          const usdtFloat = Number(
            ethers.utils.formatUnits(usdt, USDT_DECIMALS)
          );
          estimatedReceiveEl.textContent = `${formatNumber(usdtFloat, 4)} USDT`;
          estimatedExtraEl.textContent = "Network fees are not included";
        } catch (err) {
          console.warn("Failed to update estimate", err);
          estimatedReceiveEl.textContent = "– USDT";
          estimatedExtraEl.textContent = "Invalid amount";
        }
      }

      async function sellFlow() {
        if (isSelling) return;
        if (!userAddress || !signer || !potContract || !buybackContract) {
          setHelperMessage("Wallet is not ready. Please reconnect.", "error");
          return;
        }

        const raw = amountInput.value.trim();
        if (!raw || Number(raw) <= 0) {
          setHelperMessage("Enter a valid POT amount.", "error");
          return;
        }

        try {
          const chainId = await provider.request({ method: "eth_chainId" });
          if (chainId.toLowerCase() !== BSC_CHAIN_ID_HEX.toLowerCase()) {
            setHelperMessage(
              "Wrong network. Switch to BNB Smart Chain (56) in your wallet.",
              "error"
            );
            return;
          }
        } catch (err) {
          console.warn("Unable to verify chain before sell", err);
        }

        isSelling = true;
        sellButton.disabled = true;
        setHelperMessage("Checking allowance and sending transaction...", "muted");

        try {
          const amountPOT = ethers.utils.parseUnits(raw, POT_DECIMALS);

          // Safe approve pattern for tokens that require setting allowance to 0 first
          const currentAllowance = await potContract.allowance(
            userAddress,
            BUYBACK_CONTRACT_ADDRESS
          );

          if (currentAllowance.lt(amountPOT)) {
            setHelperMessage("Approving POT spend for buyback contract...", "muted");

            if (!currentAllowance.isZero()) {
              const resetTx = await potContract.approve(
                BUYBACK_CONTRACT_ADDRESS,
                ethers.constants.Zero
              );
              await resetTx.wait(1);
            }

            const approveTx = await potContract.approve(
              BUYBACK_CONTRACT_ADDRESS,
              ethers.constants.MaxUint256
            );
            await approveTx.wait(1);
          }

          setHelperMessage("Sending sell transaction...", "muted");
          const sellTx = await buybackContract.sellTokens(amountPOT);
          setHelperMessage("Waiting for confirmation...", "muted");
          await sellTx.wait(1);

          setHelperMessage("Sell completed successfully.", "ok");
          amountInput.value = "";
          percentButtons.forEach((btn) => btn.classList.remove("active"));
          await refreshBalance();
          await refreshPrice();
          updateEstimate();
        } catch (err) {
          console.error("Sell transaction failed", err);
          const msg = extractErrorMessage(err);
          if (err && (err.code === 4001 || err.code === "ACTION_REJECTED")) {
            setHelperMessage("User rejected transaction.", "error");
          } else {
            setHelperMessage("Sell failed: " + msg, "error");
          }
        } finally {
          isSelling = false;
          setSellButtonState();
        }
      }

      function disconnectWalletFlow() {
        userAddress = null;
        signer = null;
        ethersProvider = null;
        potContract = null;
        buybackContract = null;

        setWalletUIDisconnected();
        setNetworkUI(null);
        setHelperMessage(
          "Disconnected locally. You may still be connected inside your wallet.",
          "muted"
        );
        setSellButtonState();
      }

      // ============ EVENTS ============

      connectButton.addEventListener("click", connectWalletFlow);
      disconnectButton.addEventListener("click", disconnectWalletFlow);
      sellButton.addEventListener("click", sellFlow);

      amountInput.addEventListener("input", () => {
        percentButtons.forEach((btn) => btn.classList.remove("active"));
        updateEstimate();
        setSellButtonState();
      });

      percentButtons.forEach((btn) => {
        btn.addEventListener("click", async () => {
          if (!potContract || !userAddress) {
            setHelperMessage("Connect wallet to read POT balance.", "error");
            return;
          }

          percentButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          const pct = Number(btn.dataset.percent || "0");
          try {
            const balRaw = await potContract.balanceOf(userAddress);
            const bal = Number(
              ethers.utils.formatUnits(balRaw, POT_DECIMALS)
            );
            const selected = (bal * pct) / 100;
            amountInput.value = selected > 0 ? selected.toString() : "";
            updateEstimate();
            setSellButtonState();
          } catch (err) {
            console.warn("Failed to apply percentage", err);
          }
        });
      });

      // Initial UI
      setWalletUIDisconnected();
      setNetworkUI(null);
      pricePerPotEl.textContent = "Loading...";
      priceExtraEl.textContent = "Waiting for wallet connection";
      estimatedReceiveEl.textContent = "– USDT";
      estimatedExtraEl.textContent = "Enter POT amount";

      window.addEventListener("load", async () => {
        const injected = getInjectedProvider();
        if (!injected) return;

        try {
          const chainId = await injected.request({ method: "eth_chainId" });
          setNetworkUI(chainId);
        } catch (err) {
          console.warn("Could not read chainId on load", err);
        }
      });
    </script>
  </body>
</html>
