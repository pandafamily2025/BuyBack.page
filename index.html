<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>POT Buyback Portal</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg-main: #040714;
      --bg-card: #070b1c;
      --bg-card-soft: #0e1529;
      --accent: #18c36b;
      --accent-soft: rgba(24, 195, 107, 0.15);
      --accent-orange: #ffb347;
      --danger: #ff4b5c;
      --danger-soft: rgba(255, 75, 92, 0.14);
      --text-main: #f5f7ff;
      --text-soft: #a5b1d8;
      --border-soft: #1a2138;
      --pill-bg: #0c1224;
      --pill-soft: rgba(255, 255, 255, 0.04);
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.75);
      --radius-lg: 26px;
      --radius-pill: 999px;
      --transition-fast: 0.18s ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 12px 32px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        Roboto, sans-serif;
      background: radial-gradient(circle at top, #151b3d 0, #02030a 52%, #000 100%);
      color: var(--text-main);
    }

    .shell {
      width: 100%;
      max-width: 480px;
      background: radial-gradient(circle at top left, #172342, #050816);
      border-radius: 32px;
      padding: 18px 14px 22px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .shell::before {
      content: "";
      position: absolute;
      inset: -120px;
      background:
        radial-gradient(circle at top left, rgba(72, 149, 239, 0.22), transparent 60%),
        radial-gradient(circle at top right, rgba(239, 159, 72, 0.2), transparent 60%);
      opacity: 0.75;
      pointer-events: none;
    }

    .shell-inner {
      position: relative;
      z-index: 1;
    }

    header.portal-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
    }

    .logo-wrap {
      width: 64px;
      height: 64px;
      border-radius: 22px;
      padding: 2px;
      background: radial-gradient(circle at 0 0, #ffb347, #ff5f6d 40%, #7f5dff 100%);
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.7);
      flex-shrink: 0;
    }

    .logo-inner {
      width: 100%;
      height: 100%;
      border-radius: 20px;
      background: #0b1324;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .logo-inner img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 18px;
      display: block;
    }

    .title-block {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .title-block h1 {
      font-size: 20px;
      letter-spacing: 0.03em;
      margin: 0;
      font-weight: 700;
      color: #ffffff;
    }

    .subtitle {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
      margin: 0;
    }

    .token-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      background: radial-gradient(circle at 0 0, #2a9dff, #1452ff);
      color: #e8f1ff;
      margin-top: 4px;
    }

    .token-pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.8);
    }

    .mode-row {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.2fr);
      gap: 8px;
      margin-bottom: 14px;
    }

    .chip {
      border-radius: var(--radius-pill);
      padding: 8px 12px;
      font-size: 11px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: rgba(4, 9, 32, 0.8);
      border: 1px solid rgba(255, 255, 255, 0.05);
      color: var(--text-soft);
    }

    .chip.label {
      justify-content: space-between;
      padding-inline: 12px 14px;
    }

    .chip-label {
      opacity: 0.7;
    }

    .chip-value {
      font-weight: 600;
      color: #ffffff;
    }

    .chip.mode {
      justify-content: flex-start;
      gap: 6px;
      background: rgba(15, 24, 52, 0.95);
    }

    .chip.mode span.value {
      font-weight: 600;
      color: #ffffff;
    }

    .chip.payout {
      background: rgba(8, 19, 40, 0.9);
    }

    .status-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 14px;
    }

    .status-pill {
      border-radius: var(--radius-pill);
      padding: 9px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      background: var(--pill-bg);
      border: 1px solid var(--border-soft);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
    }

    .status-pill .label {
      color: var(--text-soft);
    }

    .status-pill .value {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 600;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .dot.green {
      background: #18c36b;
      box-shadow: 0 0 6px rgba(24, 195, 107, 0.75);
    }

    .dot.red {
      background: var(--danger);
      box-shadow: 0 0 6px rgba(255, 75, 92, 0.8);
    }

    .pill-soft {
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.03);
      font-size: 10px;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .card {
      border-radius: var(--radius-lg);
      background: radial-gradient(circle at top left, #121a35, #050816 60%);
      border: 1px solid rgba(255, 255, 255, 0.04);
      padding: 16px 14px 14px;
      margin-bottom: 12px;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.7);
    }

    .card-header-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 10px;
    }

    .card-header-row .title {
      font-size: 12px;
      letter-spacing: 0.24em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .card-header-row .network-pill {
      font-size: 11px;
      padding: 6px 11px;
      border-radius: var(--radius-pill);
      background: rgba(11, 22, 46, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.05);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .card-header-row .network-pill span.value {
      font-weight: 600;
      color: #ffffff;
    }

    .address-row {
      border-radius: 999px;
      background: #050816;
      border: 1px solid var(--border-soft);
      padding: 9px 12px;
      font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .address-row span {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .button-row {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1fr);
      gap: 8px;
      margin-bottom: 4px;
    }

    .btn {
      border: none;
      outline: none;
      border-radius: var(--radius-pill);
      padding: 11px 14px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast), opacity var(--transition-fast);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1ddf7a, #0fb45a);
      color: #02130b;
      box-shadow: 0 12px 24px rgba(24, 195, 107, 0.5);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-soft);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .btn:not(:disabled):active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.8);
    }

    .inline-help {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 2px;
    }

    .amount-card {
      margin-top: 8px;
      padding-top: 12px;
      border-top: 1px solid rgba(255, 255, 255, 0.04);
    }

    .amount-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 12px;
    }

    .amount-row .label {
      font-size: 11px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .amount-row .balance {
      font-size: 11px;
      color: var(--text-soft);
      opacity: 0.9;
    }

    .percent-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 8px;
    }

    .percent-btn {
      border-radius: var(--radius-pill);
      border: 1px solid rgba(255, 255, 255, 0.06);
      background: rgba(9, 13, 30, 0.9);
      padding: 6px 4px;
      font-size: 11px;
      color: var(--text-soft);
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }

    .percent-btn:hover {
      background: rgba(15, 25, 52, 0.96);
      border-color: rgba(255, 255, 255, 0.12);
      color: #ffffff;
      transform: translateY(-0.5px);
    }

    .percent-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: #e8fff4;
    }

    .input-wrap {
      position: relative;
      border-radius: var(--radius-pill);
      background: #050816;
      border: 1px solid var(--border-soft);
      padding: 7px 7px 7px 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    .input-wrap input {
      flex: 1;
      border: none;
      outline: none;
      background: transparent;
      color: #ffffff;
      font-size: 14px;
      font-weight: 500;
    }

    .input-wrap input::placeholder {
      color: rgba(139, 154, 207, 0.8);
    }

    .token-pill-input {
      border-radius: var(--radius-pill);
      background: rgba(255, 191, 105, 0.12);
      border: 1px solid rgba(255, 191, 105, 0.55);
      padding: 5px 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      color: #ffd89b;
      white-space: nowrap;
    }

    .token-pill-input span.dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: radial-gradient(circle at 0 0, #ffd27f, #ff9a3c);
      box-shadow: 0 0 6px rgba(255, 184, 108, 0.9);
    }

    .pill-subtext {
      font-size: 10px;
      color: var(--text-soft);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 7px;
      margin-bottom: 10px;
    }

    .info-box {
      border-radius: 18px;
      padding: 9px 10px 8px;
      background: rgba(6, 11, 30, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .info-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .info-value {
      font-size: 13px;
      font-weight: 600;
    }

    .info-sub {
      margin-top: 3px;
      font-size: 10px;
      color: var(--text-soft);
      opacity: 0.9;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 7px;
      margin-bottom: 12px;
    }

    .status-box {
      border-radius: 18px;
      padding: 8px 10px;
      background: rgba(5, 9, 24, 0.98);
      border: 1px solid rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .status-box-label {
      font-size: 10px;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .status-box-value {
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 2px;
    }

    .status-box-value span.text {
      font-weight: 600;
    }

    .primary-action-wrap {
      margin-bottom: 6px;
    }

    .primary-action-wrap .btn-primary {
      width: 100%;
      padding-block: 12px;
      font-size: 15px;
      border-radius: 20px;
    }

    .helper-text {
      font-size: 11px;
      text-align: center;
      color: var(--text-soft);
      margin-top: 6px;
    }

    .helper-text strong {
      color: #ffffff;
      font-weight: 500;
    }

    .error-bar {
      margin-top: 6px;
      border-radius: 14px;
      padding: 7px 10px;
      font-size: 11px;
      color: #ffd9dd;
      background: var(--danger-soft);
      border: 1px solid rgba(255, 75, 92, 0.7);
      display: none;
    }

    .error-bar.visible {
      display: block;
    }

    footer.portal-footer {
      margin-top: 14px;
      border-radius: 22px;
      padding: 10px 12px 12px;
      background: rgba(4, 9, 24, 0.96);
      border: 1px solid rgba(255, 255, 255, 0.04);
    }

    footer.portal-footer h3 {
      font-size: 11px;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--text-soft);
      margin: 0 0 6px;
    }

    footer.portal-footer ol {
      padding-left: 18px;
      margin: 0;
    }

    footer.portal-footer li {
      font-size: 11px;
      color: var(--text-soft);
      margin-bottom: 3px;
    }

    footer.portal-footer li strong {
      color: #ffffff;
      font-weight: 500;
    }

    @media (max-width: 480px) {
      .shell {
        padding-inline: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div class="shell-inner">
      <header class="portal-header">
        <div class="logo-wrap">
          <div class="logo-inner">
            <img src="panda-logo.png" alt="Panda logo" />
          </div>
        </div>
        <div class="title-block">
          <h1>POT Buyback Portal</h1>
          <p class="subtitle">Sell POT directly for USDT on BSC</p>
          <div class="token-pill">
            <span class="dot"></span>
            <span>Playtopia Organization Token</span>
          </div>
        </div>
      </header>

      <div class="mode-row">
        <div class="chip mode">
          <span class="chip-label">Mode</span>
          <span class="value">Direct contract buyback</span>
        </div>
        <div class="chip payout">
          <span class="chip-label">Payout token</span>
          <span class="chip-value">BEP-20 USDT</span>
        </div>
      </div>

      <div class="status-row">
        <div class="status-pill" id="walletStatusPill">
          <span class="label">Wallet</span>
          <span class="value">
            <span class="dot red" id="walletStatusDot"></span>
            <span id="walletStatusText">Disconnected</span>
          </span>
        </div>
        <div class="status-pill" id="networkStatusPill">
          <span class="label">Network</span>
          <span class="value">
            <span class="dot red" id="networkStatusDot"></span>
            <span id="networkStatusText">Unknown</span>
          </span>
        </div>
      </div>

      <div class="card">
        <div class="card-header-row">
          <div class="title">Wallet</div>
          <div class="network-pill">
            <span class="chip-label">Chain</span>
            <span class="value" id="walletChainLabel">BSC · BEP-20</span>
          </div>
        </div>

        <div class="address-row">
          <span id="walletAddressText">Address not connected</span>
        </div>

        <div class="button-row">
          <button class="btn btn-primary" id="connectButton">
            Connect Wallet
          </button>
          <button class="btn btn-outline" id="disconnectButton" disabled>
            Disconnect
          </button>
        </div>
        <div class="inline-help" id="neutralMessage">
          Connect your wallet on BNB Smart Chain (chain 56) to start.
        </div>

        <div class="amount-card">
          <div class="amount-row">
            <div class="label">Amount of POT to sell</div>
            <div class="balance">
              Balance: <span id="potBalanceText">– POT</span>
            </div>
          </div>

          <div class="percent-row">
            <button class="percent-btn" data-percent="25">25%</button>
            <button class="percent-btn" data-percent="50">50%</button>
            <button class="percent-btn" data-percent="75">75%</button>
            <button class="percent-btn" data-percent="100">100%</button>
          </div>

          <div class="input-wrap">
            <input
              id="potInput"
              inputmode="decimal"
              autocomplete="off"
              placeholder="e.g. 1000"
            />
            <div class="token-pill-input">
              <span class="dot"></span>
              <span>POT</span>
            </div>
          </div>

          <div class="info-grid">
            <div class="info-box">
              <div class="info-label">Buyback price</div>
              <div class="info-value" id="priceText">Loading...</div>
              <div class="info-sub">Read from buyback contract</div>
            </div>

            <div class="info-box">
              <div class="info-label">Estimated receive</div>
              <div class="info-value" id="estimatedReceiveText">– USDT</div>
              <div class="info-sub">Network fees are not included</div>
            </div>
          </div>

          <div class="status-grid">
            <div class="status-box">
              <div class="status-box-label">Wallet status</div>
              <div class="status-box-value">
                <span class="dot red" id="walletStatusBoxDot"></span>
                <span class="text" id="walletStatusBoxText">Disconnected</span>
              </div>
            </div>
            <div class="status-box">
              <div class="status-box-label">Network status</div>
              <div class="status-box-value">
                <span class="dot red" id="networkStatusBoxDot"></span>
                <span class="text" id="networkStatusBoxText">Unknown</span>
              </div>
            </div>
          </div>

          <div class="primary-action-wrap">
            <button class="btn btn-primary" id="sellButton">
              Sell POT for USDT
            </button>
          </div>

          <div class="helper-text" id="helperText">
            <span id="helperInner">
              Enter POT amount and confirm the transaction.
            </span>
          </div>

          <div class="error-bar" id="errorBar"></div>
        </div>
      </div>

      <footer class="portal-footer">
        <h3>How it works</h3>
        <ol>
          <li>
            <strong>Connect</strong> your wallet on
            <strong>BNB Smart Chain (chain 56)</strong>.
          </li>
          <li>
            <strong>Enter</strong> the amount of POT or use quick percentage
            buttons.
          </li>
          <li>
            Confirm <strong>approval</strong> on the POT token (first time),
            then confirm the <strong>sell</strong> transaction.
          </li>
          <li>
            You will receive <strong>BEP-20 USDT</strong> from the buyback
            contract liquidity, directly into your wallet.
          </li>
        </ol>
      </footer>
    </div>
  </div>

  <script>
    const BUYBACK_ADDRESS = "0x9652CC7355C759DB295E8bd5A21d4D707FC07085";
    const POT_ADDRESS = "0x66059443da552aAe6a032E3a84307E6BBbd3cd01";
    const BSC_CHAIN_ID_HEX = "0x38";
    const POT_DECIMALS = 18;

    const ERC20_ABI = [
      "function balanceOf(address owner) view returns (uint256)",
      "function allowance(address owner, address spender) view returns (uint256)",
      "function approve(address spender, uint256 value) returns (bool)",
      "function decimals() view returns (uint8)"
    ];

    const BUYBACK_ABI = [
      "function price() view returns (uint256)",
      "function sellTokens(uint256 amount) external",
      "function token() view returns (address)",
      "function usdt() view returns (address)"
    ];

    let provider = null;
    let signer = null;
    let userAddress = null;
    let currentChainId = null;
    let potContract = null;
    let buybackContract = null;

    let userPotBalance = 0;
    let pricePerPot = 0;

    const connectButton = document.getElementById("connectButton");
    const disconnectButton = document.getElementById("disconnectButton");
    const potInput = document.getElementById("potInput");
    const priceText = document.getElementById("priceText");
    const estimatedReceiveText = document.getElementById("estimatedReceiveText");
    const potBalanceText = document.getElementById("potBalanceText");
    const walletAddressText = document.getElementById("walletAddressText");
    const walletStatusPill = document.getElementById("walletStatusPill");
    const networkStatusPill = document.getElementById("networkStatusPill");
    const walletStatusDot = document.getElementById("walletStatusDot");
    const networkStatusDot = document.getElementById("networkStatusDot");
    const walletStatusText = document.getElementById("walletStatusText");
    const networkStatusText = document.getElementById("networkStatusText");
    const walletStatusBoxDot = document.getElementById("walletStatusBoxDot");
    const networkStatusBoxDot = document.getElementById("networkStatusBoxDot");
    const walletStatusBoxText = document.getElementById("walletStatusBoxText");
    const networkStatusBoxText = document.getElementById("networkStatusBoxText");
    const walletChainLabel = document.getElementById("walletChainLabel");
    const sellButton = document.getElementById("sellButton");
    const errorBar = document.getElementById("errorBar");
    const helperText = document.getElementById("helperText");
    const helperInner = document.getElementById("helperInner");
    const neutralMessage = document.getElementById("neutralMessage");

    function shortenAddress(addr) {
      if (!addr) return "";
      return addr.slice(0, 6) + "..." + addr.slice(-4);
    }

    function setDot(dotEl, isOk) {
      dotEl.classList.toggle("green", isOk);
      dotEl.classList.toggle("red", !isOk);
    }

    function setError(message) {
      if (!message) {
        errorBar.classList.remove("visible");
        errorBar.textContent = "";
        return;
      }
      errorBar.textContent = message;
      errorBar.classList.add("visible");
    }

    function clearError() {
      setError("");
    }

    function setHelper(message) {
      if (message) {
        helperInner.textContent = message;
      }
    }

    function updateWalletUIConnected() {
      const short = shortenAddress(userAddress);
      walletAddressText.textContent = short || "Address not connected";
      walletStatusText.textContent = userAddress ? "Connected" : "Disconnected";
      walletStatusBoxText.textContent = userAddress ? "Connected" : "Disconnected";
      setDot(walletStatusDot, !!userAddress);
      setDot(walletStatusBoxDot, !!userAddress);

      connectButton.disabled = !!userAddress;
      disconnectButton.disabled = !userAddress;

      if (!userAddress) {
        potBalanceText.textContent = "– POT";
        userPotBalance = 0;
        potInput.value = "";
      }
    }

    function updateNetworkUI() {
      let label = "Unknown";
      let ok = false;
      if (currentChainId === 56) {
        label = "BNB Smart Chain (56)";
        ok = true;
      } else if (currentChainId) {
        label = "Chain " + currentChainId;
      }

      networkStatusText.textContent = label;
      networkStatusBoxText.textContent = label;
      walletChainLabel.textContent = "BNB Smart Chain · BEP-20";
      setDot(networkStatusDot, ok);
      setDot(networkStatusBoxDot, ok);

      if (userAddress && !ok) {
        setHelper("Wrong network. Please switch to BNB Smart Chain (56) in your wallet.");
      } else if (userAddress && ok) {
        setHelper("Enter POT amount and confirm the transaction.");
      }
    }

    async function initContracts() {
      if (!signer) return;
      potContract = new ethers.Contract(POT_ADDRESS, ERC20_ABI, signer);
      buybackContract = new ethers.Contract(BUYBACK_ADDRESS, BUYBACK_ABI, signer);
    }

    async function loadPrice() {
      if (!buybackContract) return;
      try {
        const rawPrice = await buybackContract.price();
        if (rawPrice && rawPrice.gt(0)) {
          pricePerPot = parseFloat(ethers.utils.formatUnits(rawPrice, POT_DECIMALS));
          priceText.textContent = pricePerPot.toFixed(6) + " USDT per POT";
        } else {
          pricePerPot = 0;
          priceText.textContent = "Error loading price";
        }
        updateEstimatedReceive();
      } catch (err) {
        console.error("Failed to load price:", err);
        pricePerPot = 0;
        priceText.textContent = "Error loading price";
      }
    }

    async function loadBalances() {
      if (!potContract || !userAddress) return;
      try {
        const rawBalance = await potContract.balanceOf(userAddress);
        userPotBalance = parseFloat(
          ethers.utils.formatUnits(rawBalance, POT_DECIMALS)
        );
        potBalanceText.textContent = userPotBalance.toFixed(4) + " POT";
      } catch (err) {
        console.error("Failed to read POT balance:", err);
        userPotBalance = 0;
        potBalanceText.textContent = "Could not read POT balance";
      }
    }

    function updateEstimatedReceive() {
      const raw = potInput.value.trim();
      if (!raw || isNaN(raw)) {
        estimatedReceiveText.textContent = "– USDT";
        return;
      }
      const amount = parseFloat(raw);
      if (!pricePerPot || !isFinite(amount)) {
        estimatedReceiveText.textContent = "– USDT";
        return;
      }
      const usdt = amount * pricePerPot;
      estimatedReceiveText.textContent = usdt.toFixed(4) + " USDT";
    }

    async function connectWallet() {
      clearError();

      if (!window.ethereum) {
        setError("No wallet provider detected. Please use MetaMask or Trust Wallet browser.");
        return;
      }

      try {
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();

        const network = await provider.getNetwork();
        currentChainId = Number(network.chainId);

        await initContracts();
        updateWalletUIConnected();
        updateNetworkUI();
        await loadBalances();
        await loadPrice();

        neutralMessage.textContent = "Wallet connected. Ready to sell POT.";
      } catch (err) {
        console.error("Connect wallet error:", err);
        setError("Failed to connect wallet. Please try again.");
      }
    }

    async function disconnectWallet() {
      clearError();
      provider = null;
      signer = null;
      userAddress = null;
      currentChainId = null;
      potContract = null;
      buybackContract = null;
      userPotBalance = 0;
      potInput.value = "";
      estimatedReceiveText.textContent = "– USDT";
      potBalanceText.textContent = "– POT";

      updateWalletUIConnected();
      updateNetworkUI();

      neutralMessage.textContent = "Connect your wallet on BNB Smart Chain (chain 56) to start.";
    }

    async function performSell() {
      clearError();

      if (!signer || !userAddress) {
        setError("Connect your wallet first.");
        return;
      }

      if (currentChainId !== 56) {
        setError("Wrong network. Please switch to BNB Smart Chain (chain 56) in your wallet.");
        return;
      }

      const rawAmount = potInput.value.trim();
      if (!rawAmount || isNaN(rawAmount)) {
        setError("Enter a valid POT amount.");
        return;
      }

      const amount = parseFloat(rawAmount);
      if (amount <= 0) {
        setError("Amount must be greater than zero.");
        return;
      }

      if (!userPotBalance || amount > userPotBalance + 0.0000001) {
        setError("Amount exceeds your POT balance.");
        return;
      }

      if (!potContract || !buybackContract) {
        setError("Contracts are not initialized. Please reconnect wallet.");
        return;
      }

      try {
        sellButton.disabled = true;
        connectButton.disabled = true;
        helperText.style.opacity = "0.8";
        setHelper("Waiting for approval and sell transaction confirmations...");

        const amountWei = ethers.utils.parseUnits(rawAmount, POT_DECIMALS);

        const allowance = await potContract.allowance(userAddress, BUYBACK_ADDRESS);
        if (allowance.lt(amountWei)) {
          const approveTx = await potContract.approve(BUYBACK_ADDRESS, amountWei);
          await approveTx.wait();
        }

        const sellTx = await buybackContract.sellTokens(amountWei);
        await sellTx.wait();

        await loadBalances();
        updateEstimatedReceive();

        setHelper("Sell completed. You should now see USDT in your wallet.");
      } catch (err) {
        console.error("Sell error:", err);
        setError("Sell failed. Check your wallet and try again.");
        setHelper("If the transaction was rejected, simply try again with a valid amount.");
      } finally {
        sellButton.disabled = false;
        if (!userAddress) {
          connectButton.disabled = false;
        }
      }
    }

    function setupPercentageButtons() {
      const buttons = document.querySelectorAll(".percent-btn");
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          buttons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");

          if (!userAddress || !userPotBalance || userPotBalance <= 0) {
            setError("Cannot calculate percentage. POT balance is zero or unreadable.");
            return;
          }

          const percent = parseInt(btn.dataset.percent, 10);
          const value = (userPotBalance * percent) / 100;

          potInput.value = value.toFixed(4);
          clearError();
          updateEstimatedReceive();
        });
      });
    }

    function setupInputListener() {
      potInput.addEventListener("input", () => {
        document
          .querySelectorAll(".percent-btn")
          .forEach((b) => b.classList.remove("active"));
        clearError();
        updateEstimatedReceive();
      });
    }

    function setupWalletEvents() {
      if (!window.ethereum) return;

      window.ethereum.on("accountsChanged", (accounts) => {
        if (!accounts || accounts.length === 0) {
          disconnectWallet();
        } else {
          userAddress = accounts[0];
          connectWallet();
        }
      });

      window.ethereum.on("chainChanged", (_chainId) => {
        if (typeof _chainId === "string") {
          currentChainId = parseInt(_chainId, 16);
        } else {
          currentChainId = Number(_chainId);
        }
        updateNetworkUI();
        if (signer && userAddress) {
          initContracts()
            .then(() => Promise.all([loadBalances(), loadPrice()]))
            .catch((err) => console.error("Refresh after chain change failed:", err));
        }
      });
    }

    function init() {
      connectButton.addEventListener("click", connectWallet);
      disconnectButton.addEventListener("click", disconnectWallet);
      sellButton.addEventListener("click", performSell);

      setupPercentageButtons();
      setupInputListener();
      setupWalletEvents();

      updateWalletUIConnected();
      updateNetworkUI();
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
