<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>POT Buyback Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
      }

      :root {
        --bg-main: #050816;
        --bg-card: #101826;
        --bg-card-alt: #151e30;
        --accent: #18c964;
        --accent-soft: #133823;
        --danger: #ff4d4f;
        --danger-soft: #3c1518;
        --text-main: #ffffff;
        --text-muted: #8b95b7;
        --border-soft: rgba(255, 255, 255, 0.08);
        --chip-bg: rgba(0, 0, 0, 0.3);
        --input-bg: #050a12;
        --input-border: #283347;
        --yellow: #ffb839;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Segoe UI", sans-serif;
        background: radial-gradient(circle at top, #192341 0, #050816 55%);
        color: var(--text-main);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px 12px;
      }

      .app-shell {
        width: 100%;
        max-width: 980px;
        background: radial-gradient(circle at top left, #1b2340 0, #050816 55%);
        border-radius: 28px;
        padding: 22px 18px 24px;
        box-shadow: 0 26px 80px rgba(0, 0, 0, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.06);
      }

      @media (min-width: 768px) {
        .app-shell {
          padding: 28px 28px 30px;
        }
      }

      .app-header {
        display: flex;
        align-items: center;
        gap: 18px;
        margin-bottom: 22px;
      }

      .app-logo-wrap {
        width: 72px;
        height: 72px;
        border-radius: 999px;
        padding: 3px;
        background: radial-gradient(circle at 10% 0, #ffb839, #ff5f6c);
        box-shadow: 0 0 22px rgba(255, 184, 57, 0.7);
        flex-shrink: 0;
      }

      .app-logo {
        width: 100%;
        height: 100%;
        border-radius: 999px;
        display: block;
        object-fit: cover;
        background: #09101f;
      }

      .app-title-block {
        flex: 1;
        min-width: 0;
      }

      .app-title-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 6px;
        flex-wrap: wrap;
      }

      .app-title {
        font-size: 24px;
        font-weight: 700;
        letter-spacing: 0.02em;
      }

      .app-badge {
        padding: 4px 10px;
        border-radius: 999px;
        background: linear-gradient(90deg, #153bff, #0ec5ff);
        font-size: 10px;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: #e9f4ff;
        border: 1px solid rgba(255, 255, 255, 0.35);
      }

      .app-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        letter-spacing: 0.06em;
        text-transform: uppercase;
      }

      .app-subtitle span {
        color: #e1e6ff;
      }

      .pill-row {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
      }

      .pill {
        font-size: 11px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.35);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: var(--text-muted);
      }

      .pill strong {
        color: #e5eeff;
        font-weight: 600;
      }

      .top-status-row {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
        gap: 10px;
        margin-bottom: 18px;
      }

      @media (min-width: 880px) {
        .top-status-row {
          grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.1fr);
        }
      }

      .status-chip {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 10px;
        border-radius: 999px;
        background: #070d18;
        border: 1px solid rgba(255, 255, 255, 0.06);
        gap: 8px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 999px;
      }

      .status-dot--success {
        background: #18c964;
        box-shadow: 0 0 14px rgba(24, 201, 100, 0.8);
      }

      .status-dot--error {
        background: #ff4d4f;
        box-shadow: 0 0 14px rgba(255, 77, 79, 0.8);
      }

      .status-label {
        color: #aab5d7;
      }

      .status-value {
        color: #f5f6ff;
        font-weight: 600;
      }

      .main-grid {
        display: grid;
        grid-template-columns: minmax(0, 1.3fr);
        gap: 16px;
      }

      @media (min-width: 880px) {
        .main-grid {
          grid-template-columns: minmax(0, 1.45fr) minmax(0, 1fr);
        }
      }

      .card {
        background: radial-gradient(circle at top, #171f34 0, #111729 56%);
        border-radius: 20px;
        padding: 16px 16px 18px;
        border: 1px solid var(--border-soft);
      }

      .card--side {
        background: linear-gradient(145deg, #0b1020 0, #060913 72%);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-bottom: 12px;
      }

      .card-title {
        font-size: 13px;
        text-transform: uppercase;
        letter-spacing: 0.16em;
        color: var(--text-muted);
      }

      .card-pill {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #e5ecff;
      }

      .field-label-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .field-label-title {
        font-size: 11px;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .field-label-extra {
        font-size: 11px;
        color: #e7ecff;
      }

      .badge-soft {
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.35);
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-muted);
      }

      .badge-soft span {
        color: #f9fbff;
      }

      .wallet-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 10px 9px;
        border-radius: 16px;
        background: linear-gradient(130deg, #050913 0, #101828 70%);
        border: 1px solid var(--input-border);
        margin-bottom: 14px;
      }

      .wallet-meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .wallet-label {
        font-size: 11px;
        letter-spacing: 0.14em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .wallet-address {
        font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        color: #e9eeff;
      }

      .wallet-address--muted {
        color: var(--text-muted);
      }

      .btn {
        border: none;
        outline: none;
        border-radius: 999px;
        padding: 9px 18px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.08s ease, box-shadow 0.08s ease,
          background 0.08s ease, opacity 0.08s ease;
        white-space: nowrap;
      }

      .btn-primary {
        background: linear-gradient(135deg, #17c964, #0fb05a);
        color: #041109;
        box-shadow: 0 10px 24px rgba(23, 201, 100, 0.6);
      }

      .btn-primary:active {
        transform: translateY(1px);
        box-shadow: 0 6px 18px rgba(23, 201, 100, 0.5);
      }

      .btn-outline {
        background: transparent;
        color: #e3e9ff;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }

      .btn-outline:active {
        transform: translateY(1px);
      }

      .btn-wide {
        width: 100%;
        justify-content: center;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 12px 18px;
        font-size: 14px;
        border-radius: 18px;
      }

      .btn-danger {
        background: linear-gradient(135deg, #ff4d4f, #ff784a);
        color: #fff7f8;
        box-shadow: 0 10px 26px rgba(255, 77, 79, 0.6);
      }

      .btn:disabled {
        opacity: 0.55;
        cursor: default;
        box-shadow: none;
        transform: none;
      }

      .amount-section {
        margin-top: 12px;
      }

      .percent-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 8px;
      }

      .percent-btn {
        flex: 1;
        min-width: 0;
        padding: 7px 0;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(7, 12, 24, 0.9);
        font-size: 11px;
        color: #cfd7ff;
        cursor: pointer;
        transition: background 0.08s ease, color 0.08s ease,
          border-color 0.08s ease, transform 0.08s ease;
      }

      .percent-btn--active {
        background: rgba(23, 201, 100, 0.16);
        border-color: #17c964;
        color: #eafff4;
      }

      .amount-input-group {
        display: flex;
        align-items: stretch;
        gap: 0;
        border-radius: 18px;
        overflow: hidden;
        border: 1px solid var(--input-border);
        background: linear-gradient(120deg, #050912, #101828);
      }

      .amount-input {
        flex: 1;
        min-width: 0;
        border: none;
        outline: none;
        padding: 11px 14px;
        background: transparent;
        color: #f6f7ff;
        font-size: 14px;
      }

      .amount-input::placeholder {
        color: #5f6b8e;
      }

      .amount-token-chip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0 14px;
        border-left: 1px solid rgba(255, 255, 255, 0.06);
        background: radial-gradient(circle at top, #1a2237 0, #0a0f1b 82%);
        font-size: 12px;
        font-weight: 600;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        color: #ffe6b3;
      }

      .amount-token-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: var(--yellow);
        margin-right: 6px;
        box-shadow: 0 0 10px rgba(255, 184, 57, 0.9);
      }

      .field-footer-row {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        margin-top: 8px;
        font-size: 11px;
      }

      .field-footer-label {
        color: var(--text-muted);
      }

      .field-footer-value {
        color: #e8edff;
      }

      .field-footer-value strong {
        font-weight: 600;
      }

      .stat-row {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
        gap: 8px;
        margin-top: 12px;
      }

      .stat-block {
        padding: 8px 10px;
        border-radius: 14px;
        background: #050913;
        border: 1px dashed rgba(255, 255, 255, 0.12);
      }

      .stat-label {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      .stat-value {
        font-size: 13px;
        font-weight: 600;
        color: #f3f6ff;
      }

      .stat-value--muted {
        color: #68739b;
      }

      .helper-text {
        margin-top: 10px;
        font-size: 11px;
        text-align: center;
        color: var(--text-muted);
      }

      .helper-text--error {
        color: #ff9b9d;
      }

      .helper-text--success {
        color: #a8ffce;
      }

      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 2px 10px;
        border-radius: 999px;
        font-size: 10px;
        letter-spacing: 0.1em;
        text-transform: uppercase;
        background: rgba(0, 0, 0, 0.4);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: #a7b1d8;
      }

      .status-dot-small {
        width: 7px;
        height: 7px;
        border-radius: 999px;
      }

      .status-badge--success .status-dot-small {
        background: #18c964;
        box-shadow: 0 0 10px rgba(24, 201, 100, 0.8);
      }

      .status-badge--error .status-dot-small {
        background: #ff4d4f;
        box-shadow: 0 0 10px rgba(255, 77, 79, 0.8);
      }

      .side-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .how-list {
        list-style: none;
        padding-left: 0;
        margin: 8px 0 0;
        font-size: 12px;
        color: #c7d0ff;
      }

      .how-list li {
        margin-bottom: 4px;
      }

      .how-list li span {
        color: #f6f8ff;
      }

      .safety-box {
        margin-top: 8px;
        padding: 8px 10px;
        border-radius: 14px;
        background: rgba(5, 9, 19, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.12);
        font-size: 11px;
        color: #a5b2e0;
      }

      .safety-box-title {
        text-transform: uppercase;
        letter-spacing: 0.14em;
        font-size: 10px;
        color: var(--text-muted);
        margin-bottom: 4px;
      }

      .addr-mono {
        font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas,
          "Liberation Mono", "Courier New", monospace;
        font-size: 11px;
        color: #e6ecff;
      }

      .payout-note {
        margin-top: 8px;
        font-size: 11px;
        text-align: center;
        color: var(--text-muted);
      }

      .payout-note span {
        color: #eaf0ff;
      }

      .footer-small {
        margin-top: 10px;
        font-size: 10px;
        text-align: center;
        color: #616a90;
      }

      .footer-small span {
        color: #9fa9d8;
      }
    </style>
  </head>

  <body>
    <main class="app-shell">
      <!-- Header -->
      <header class="app-header">
        <div class="app-logo-wrap">
          <img
            src="panda-logo.png"
            alt="Panda logo"
            class="app-logo"
          />
        </div>
        <div class="app-title-block">
          <div class="app-title-row">
            <h1 class="app-title">POT Buyback Portal</h1>
            <span class="app-badge">Playtopia Organization Token</span>
          </div>
          <div class="app-subtitle">
            Sell <span>POT</span> directly for <span>USDT</span> on
            <span>BSC</span>
          </div>
          <div class="pill-row">
            <div class="pill">
              Mode: <strong>Direct contract buyback</strong>
            </div>
            <div class="pill">
              Payout token: <strong>BEP-20&nbsp;USDT</strong>
            </div>
          </div>
        </div>
      </header>

      <!-- Wallet / network chips -->
      <section class="top-status-row">
        <div class="status-chip">
          <div class="status-dot status-dot--error" id="wallet-dot"></div>
          <span class="status-label">Wallet</span>
          <span class="status-value" id="wallet-status-text">Disconnected</span>
        </div>
        <div class="status-chip">
          <div
            class="status-dot status-dot--error"
            id="network-dot"
          ></div>
          <span class="status-label">Network</span>
          <span class="status-value" id="network-status-text"
            >Network: Unknown (–)</span
          >
        </div>
      </section>

      <!-- Main layout -->
      <section class="main-grid">
        <!-- Left: Main form -->
        <section class="card">
          <!-- Wallet row -->
          <div class="field-label-row">
            <span class="field-label-title">Wallet</span>
            <span class="badge-soft">
              Chain: <span>BNB Smart Chain · BEP-20</span>
            </span>
          </div>

          <div class="wallet-row">
            <div class="wallet-meta">
              <span class="wallet-label">Address</span>
              <span
                class="wallet-address wallet-address--muted"
                id="wallet-address"
                >Not connected</span
              >
            </div>
            <div style="display: flex; gap: 8px">
              <button
                class="btn btn-primary"
                id="btn-connect"
              >
                Connect Wallet
              </button>
              <button
                class="btn btn-outline"
                id="btn-disconnect"
                disabled
              >
                Disconnect
              </button>
            </div>
          </div>

          <!-- Amount section -->
          <section class="amount-section">
            <div class="field-label-row">
              <span class="field-label-title">Amount of POT to sell</span>
              <span class="field-label-extra">
                Balance:
                <span id="balance-text">– POT</span>
              </span>
            </div>

            <div class="percent-row">
              <button
                class="percent-btn"
                type="button"
                data-percent="25"
              >
                25%
              </button>
              <button
                class="percent-btn"
                type="button"
                data-percent="50"
              >
                50%
              </button>
              <button
                class="percent-btn"
                type="button"
                data-percent="75"
              >
                75%
              </button>
              <button
                class="percent-btn"
                type="button"
                data-percent="100"
              >
                100%
              </button>
            </div>

            <div class="amount-input-group">
              <input
                id="amount-input"
                class="amount-input"
                type="text"
                inputmode="decimal"
                autocomplete="off"
                placeholder="e.g. 1000"
              />
              <div class="amount-token-chip">
                <span class="amount-token-dot"></span>
                POT
              </div>
            </div>

            <div class="field-footer-row">
              <span class="field-footer-label">Buyback price</span>
              <span class="field-footer-value stat-value stat-value--muted">
                <span id="buyback-price">Loading...</span>
              </span>
            </div>

            <div class="field-footer-row">
              <span class="field-footer-label">Estimated receive</span>
              <span
                class="field-footer-value stat-value stat-value--muted"
                id="estimated-receive"
                >– USDT</span
              >
            </div>

            <div class="stat-row">
              <div class="stat-block">
                <div class="stat-label">Wallet status</div>
                <div
                  class="stat-value stat-value--muted"
                  id="wallet-badge"
                >
                  <span class="status-badge status-badge--error">
                    <span class="status-dot-small"></span>
                    <span>Disconnected</span>
                  </span>
                </div>
              </div>
              <div class="stat-block">
                <div class="stat-label">Network status</div>
                <div
                  class="stat-value stat-value--muted"
                  id="network-badge"
                >
                  <span class="status-badge status-badge--error">
                    <span class="status-dot-small"></span>
                    <span>Unknown</span>
                  </span>
                </div>
              </div>
            </div>

            <button
              class="btn btn-primary btn-wide"
              id="btn-sell"
              disabled
            >
              Sell POT for USDT
            </button>

            <p class="helper-text helper-text--error" id="helper-text">
              Connect your wallet to start.
            </p>

            <p class="payout-note">
              Payout token:
              <span>BEP-20 USDT (from buyback contract liquidity)</span>
            </p>
          </section>
        </section>

        <!-- Right: How it works / safety -->
        <section class="card card--side side-section">
          <div>
            <div class="card-header">
              <h2 class="card-title">How it works</h2>
              <span class="card-pill">Direct on-chain settlement</span>
            </div>
            <ul class="how-list">
              <li>
                1. Connect your wallet on
                <span>BNB Smart Chain (chain 56)</span>.
              </li>
              <li>
                2. Enter the amount of <span>POT</span> or use percentage
                buttons.
              </li>
              <li>
                3. Confirm <span>approval</span> (first time), then confirm the
                <span>sell</span> transaction.
              </li>
              <li>
                4. You receive <span>BEP-20 USDT</span> directly from the
                buyback contract liquidity.
              </li>
            </ul>
          </div>

          <div class="safety-box">
            <div class="safety-box-title">Safety checks</div>
            <div style="margin-bottom: 4px">
              Buyback contract:
              <span class="addr-mono"
                >0x9652CC7355C759DB295E8bd5A21d4D707FC07085</span
              >
            </div>
            <div>
              POT token:
              <span class="addr-mono"
                >0x66059443da552aAe6a032E3a84307E6BBbd3cd01</span
              >
            </div>
          </div>

          <p class="footer-small">
            Always verify contract addresses from an official source before
            sending funds. <span>Never</span> share your seed phrase.
          </p>
        </section>
      </section>
    </main>

    <script>
      // ==== Constants ====
      const BSC_CHAIN_ID_DEC = 56;
      const BSC_CHAIN_ID_HEX = "0x38";

      const BUYBACK_CONTRACT_ADDRESS =
        "0x9652CC7355C759DB295E8bd5A21d4D707FC07085";
      const POT_TOKEN_ADDRESS =
        "0x66059443da552aAe6a032E3a84307E6BBbd3cd01";

      const TOKEN_DECIMALS = 18;
      const PRICE_DECIMALS = 18;

      const buybackAbi = [
        "function price() view returns (uint256)",
        "function sellTokens(uint256 amount) external",
        "function token() view returns (address)",
        "function usdt() view returns (address)",
      ];

      const erc20Abi = [
        "function balanceOf(address owner) view returns (uint256)",
        "function allowance(address owner, address spender) view returns (uint256)",
        "function approve(address spender, uint256 amount) external returns (bool)",
        "function decimals() view returns (uint8)",
      ];

      // ==== State ====
      let provider = null;
      let signer = null;
      let userAddress = null;
      let buybackContract = null;
      let tokenContract = null;

      let currentPrice = null;
      let currentBalance = null;

      // ==== DOM ====
      const walletDot = document.getElementById("wallet-dot");
      const networkDot = document.getElementById("network-dot");
      const walletStatusText = document.getElementById("wallet-status-text");
      const networkStatusText = document.getElementById("network-status-text");

      const walletBadge = document.getElementById("wallet-badge");
      const networkBadge = document.getElementById("network-badge");
      const walletAddressEl = document.getElementById("wallet-address");

      const btnConnect = document.getElementById("btn-connect");
      const btnDisconnect = document.getElementById("btn-disconnect");
      const btnSell = document.getElementById("btn-sell");

      const amountInput = document.getElementById("amount-input");
      const percentButtons = Array.from(
        document.querySelectorAll(".percent-btn")
      );

      const balanceText = document.getElementById("balance-text");
      const buybackPriceEl = document.getElementById("buyback-price");
      const estimatedReceiveEl = document.getElementById("estimated-receive");
      const helperTextEl = document.getElementById("helper-text");

      // ==== Helpers ====
      function shortenAddress(addr) {
        if (!addr || addr.length < 10) return addr || "";
        return addr.slice(0, 6) + "..." + addr.slice(-4);
      }

      function setWalletStatus(connected) {
        if (connected) {
          walletDot.classList.remove("status-dot--error");
          walletDot.classList.add("status-dot--success");
          walletStatusText.textContent = "Connected";

          walletBadge.innerHTML = `
            <span class="status-badge status-badge--success">
              <span class="status-dot-small"></span>
              <span>Connected</span>
            </span>`;
        } else {
          walletDot.classList.remove("status-dot--success");
          walletDot.classList.add("status-dot--error");
          walletStatusText.textContent = "Disconnected";

          walletAddressEl.textContent = "Not connected";
          walletAddressEl.classList.add("wallet-address--muted");

          walletBadge.innerHTML = `
            <span class="status-badge status-badge--error">
              <span class="status-dot-small"></span>
              <span>Disconnected</span>
            </span>`;
        }
      }

      function setNetworkStatus(isBsc, chainIdHex, chainIdDec) {
        if (isBsc) {
          networkDot.classList.remove("status-dot--error");
          networkDot.classList.add("status-dot--success");
          networkStatusText.textContent = "Network: BNB Smart Chain (56)";

          networkBadge.innerHTML = `
            <span class="status-badge status-badge--success">
              <span class="status-dot-small"></span>
              <span>BNB Smart Chain</span>
            </span>`;
        } else {
          networkDot.classList.remove("status-dot--success");
          networkDot.classList.add("status-dot--error");

          let numeric = Number.isFinite(chainIdDec)
            ? chainIdDec
            : parseInt(chainIdHex || "0x0", 16);

          if (!numeric || Number.isNaN(numeric)) {
            networkStatusText.textContent = "Network: Unknown (–)";
          } else {
            networkStatusText.textContent = `Network: Unknown (${numeric})`;
          }

          networkBadge.innerHTML = `
            <span class="status-badge status-badge--error">
              <span class="status-dot-small"></span>
              <span>Wrong network</span>
            </span>`;
        }
      }

      function setHelper(message, type = "info") {
        helperTextEl.textContent = message || "";
        helperTextEl.classList.remove(
          "helper-text--error",
          "helper-text--success"
        );

        if (type === "error") {
          helperTextEl.classList.add("helper-text--error");
        } else if (type === "success") {
          helperTextEl.classList.add("helper-text--success");
        }
      }

      function clearPercentSelection() {
        percentButtons.forEach((btn) =>
          btn.classList.remove("percent-btn--active")
        );
      }

      function formatUnitsSafe(bn, decimals) {
        try {
          return ethers.utils.formatUnits(bn, decimals);
        } catch {
          return "0";
        }
      }

      function parseUnitsSafe(value, decimals) {
        try {
          if (!value || typeof value !== "string") return null;
          const trimmed = value.trim();
          if (!trimmed) return null;
          return ethers.utils.parseUnits(trimmed, decimals);
        } catch {
          return null;
        }
      }

      async function getChainInfo() {
        const eth = window.ethereum;
        let chainIdHex = "0x0";
        let chainIdDec = 0;

        if (!eth) {
          return { chainIdHex, chainIdDec };
        }

        try {
          const raw = await eth.request({ method: "eth_chainId" });
          chainIdHex = raw;
          chainIdDec = parseInt(raw, 16);
        } catch (err) {
          console.error("Failed to read chainId via eth_chainId", err);
        }

        const netVersion = eth.networkVersion;

        // Trust Wallet fix:
        if (eth.isTrust && netVersion === "56" && chainIdDec === 1) {
          console.warn("Normalizing Trust Wallet chainId to BSC (56)");
          chainIdHex = BSC_CHAIN_ID_HEX;
          chainIdDec = BSC_CHAIN_ID_DEC;
        }

        return { chainIdHex, chainIdDec };
      }

      async function ensureContracts() {
        if (!signer) return;

        if (!buybackContract) {
          buybackContract = new ethers.Contract(
            BUYBACK_CONTRACT_ADDRESS,
            buybackAbi,
            signer
          );
        }

        if (!tokenContract) {
          tokenContract = new ethers.Contract(
            POT_TOKEN_ADDRESS,
            erc20Abi,
            signer
          );
        }
      }

      async function refreshPrice() {
        if (!buybackContract) return;

        try {
          const p = await buybackContract.price();
          currentPrice = p;
          const display = formatUnitsSafe(p, PRICE_DECIMALS);
          buybackPriceEl.textContent = `${display} USDT per POT`;
          buybackPriceEl.classList.remove("stat-value--muted");
        } catch (err) {
          console.error("Error loading price:", err);
          currentPrice = null;
          buybackPriceEl.textContent = "Error loading price";
          buybackPriceEl.classList.add("stat-value--muted");
          setHelper(
            "Error loading buyback price. Please try again.",
            "error"
          );
        }
      }

      async function refreshBalance() {
        if (!tokenContract || !userAddress) return;

        try {
          const bal = await tokenContract.balanceOf(userAddress);
          currentBalance = bal;
          const display = formatUnitsSafe(bal, TOKEN_DECIMALS);
          balanceText.textContent = `${display} POT`;
        } catch (err) {
          console.error("Error loading balance:", err);
          currentBalance = null;
          balanceText.textContent = "– POT";
        }
      }

      async function refreshAll() {
        await ensureContracts();
        await Promise.all([refreshPrice(), refreshBalance()]);
        updateEstimate();
      }

      function updateEstimate() {
        const raw = amountInput.value.trim();
        if (!raw || !currentPrice) {
          estimatedReceiveEl.textContent = "– USDT";
          estimatedReceiveEl.classList.add("stat-value--muted");
          return;
        }

        const amountBn = parseUnitsSafe(raw, TOKEN_DECIMALS);
        if (!amountBn || amountBn.lte(0)) {
          estimatedReceiveEl.textContent = "– USDT";
          estimatedReceiveEl.classList.add("stat-value--muted");
          return;
        }

        try {
          const value = amountBn
            .mul(currentPrice)
            .div(ethers.BigNumber.from(10).pow(PRICE_DECIMALS));
          const display = formatUnitsSafe(value, PRICE_DECIMALS);
          estimatedReceiveEl.textContent = `${display} USDT`;
          estimatedReceiveEl.classList.remove("stat-value--muted");
        } catch (err) {
          console.error("Error computing estimate:", err);
          estimatedReceiveEl.textContent = "– USDT";
          estimatedReceiveEl.classList.add("stat-value--muted");
        }
      }

      // ==== Wallet / network logic ====

      async function connectWallet() {
        const eth = window.ethereum;

        if (!eth) {
          setHelper(
            "No wallet provider found. Please open this page inside MetaMask or Trust Wallet browser.",
            "error"
          );
          return;
        }

        try:
          setHelper("Connecting wallet...");
          btnConnect.disabled = true;

          const accounts = await eth.request({
            method: "eth_requestAccounts",
          });

          if (!accounts || accounts.length === 0) {
            setHelper("No account returned from wallet.", "error");
            setWalletStatus(false);
            btnSell.disabled = true;
            btnDisconnect.disabled = true;
            return;
          }

          provider = new ethers.providers.Web3Provider(eth, "any");
          signer = provider.getSigner();
          userAddress = accounts[0];

          setWalletStatus(true);
          walletAddressEl.textContent = shortenAddress(userAddress);
          walletAddressEl.classList.remove("wallet-address--muted");

          const { chainIdHex, chainIdDec } = await getChainInfo();
          const onBsc = chainIdDec === BSC_CHAIN_ID_DEC;
          setNetworkStatus(onBsc, chainIdHex, chainIdDec);

          if (!onBsc) {
            setHelper(
              "You are not on BNB Smart Chain (chain 56). Please switch network in your wallet.",
              "error"
            );
            btnSell.disabled = true;
          } else {
            await refreshAll();
            setHelper("Wallet connected. Ready to sell POT.", "success");
            btnSell.disabled = false;
          }

          btnDisconnect.disabled = true === false; // keep enabled
          btnDisconnect.disabled = false;

          if (!eth.__pandaHandlersAttached) {
            eth.__pandaHandlersAttached = true;
            eth.on("accountsChanged", handleAccountsChanged);
            eth.on("chainChanged", handleChainChanged);
          }
        } catch (err) {
          console.error("Error connecting wallet:", err);
          if (err && err.code === 4001) {
            setHelper(
              "Connection request was rejected in your wallet.",
              "error"
            );
          } else {
            setHelper("Failed to connect wallet. Please try again.", "error");
          }
          setWalletStatus(false);
          btnSell.disabled = true;
          btnDisconnect.disabled = true;
        } finally {
          btnConnect.disabled = false;
        }
      }

      function disconnectWallet() {
        signer = null;
        provider = null;
        userAddress = null;
        buybackContract = null;
        tokenContract = null;
        currentPrice = null;
        currentBalance = null;

        amountInput.value = "";
        balanceText.textContent = "– POT";
        buybackPriceEl.textContent = "Loading...";
        buybackPriceEl.classList.add("stat-value--muted");
        estimatedReceiveEl.textContent = "– USDT";
        estimatedReceiveEl.classList.add("stat-value--muted");
        clearPercentSelection();

        setWalletStatus(false);
        setNetworkStatus(false, "0x0", 0);
        setHelper("Connect your wallet to start.", "error");
        btnSell.disabled = true;
        btnDisconnect.disabled = true;
      }

      async function handleAccountsChanged(accounts) {
        if (!accounts || accounts.length === 0) {
          disconnectWallet();
          return;
        }

        userAddress = accounts[0];
        walletAddressEl.textContent = shortenAddress(userAddress);
        walletAddressEl.classList.remove("wallet-address--muted");
        setWalletStatus(true);

        await refreshAll();
        setHelper("Wallet changed. Data refreshed.", "success");
      }

      async function handleChainChanged() {
        window.location.reload();
      }

      async function handleSell() {
        if (!signer || !userAddress) {
          setHelper("Please connect your wallet first.", "error");
          return;
        }

        const { chainIdDec } = await getChainInfo();
        const onBsc = chainIdDec === BSC_CHAIN_ID_DEC;
        setNetworkStatus(onBsc, null, chainIdDec);

        if (!onBsc) {
          setHelper(
            "You are not on BNB Smart Chain (56). Please switch network in your wallet.",
            "error"
          );
          return;
        }

        const rawAmount = amountInput.value.trim();
        const amountBn = parseUnitsSafe(rawAmount, TOKEN_DECIMALS);

        if (!amountBn || amountBn.lte(0)) {
          setHelper("Enter a valid amount of POT to sell.", "error");
          return;
        }

        if (!currentBalance || currentBalance.lte(0)) {
          setHelper("Your POT balance is zero.", "error");
          return;
        }

        if (amountBn.gt(currentBalance)) {
          setHelper("You cannot sell more POT than your balance.", "error");
          return;
        }

        await ensureContracts();

        try {
          btnSell.disabled = true;
          setHelper("Checking allowance...", "info");

          const allowance = await tokenContract.allowance(
            userAddress,
            BUYBACK_CONTRACT_ADDRESS
          );

          if (allowance.lt(amountBn)) {
            setHelper(
              "Approval required. Please confirm the approve transaction.",
              "info"
            );
            const approveTx = await tokenContract.approve(
              BUYBACK_CONTRACT_ADDRESS,
              amountBn
            );
            await approveTx.wait();
            setHelper(
              "Approval confirmed. Sending sell transaction...",
              "info"
            );
          } else {
            setHelper("Sending sell transaction...", "info");
          }

          const sellTx = await buybackContract.sellTokens(amountBn);
          await sellTx.wait();

          setHelper(
            "Sell completed successfully. Balance updated.",
            "success"
          );
          amountInput.value = "";
          clearPercentSelection();
          await refreshAll();
        } catch (err) {
          console.error("Error during sell:", err);
          if (err && err.code === 4001) {
            setHelper("Transaction was rejected in your wallet.", "error");
          } else {
            setHelper(
              "Sell failed. Please check your wallet and try again.",
              "error"
            );
          }
        } finally {
          btnSell.disabled = false;
        }
      }

      function handlePercentClick(percent) {
        if (!currentBalance || currentBalance.lte(0)) {
          return;
        }

        clearPercentSelection();
        percentButtons.forEach((btn) => {
          if (Number(btn.dataset.percent) === percent) {
            btn.classList.add("percent-btn--active");
          }
        });

        const pct = ethers.BigNumber.from(percent);
        const hundred = ethers.BigNumber.from(100);
        const amountBn = currentBalance.mul(pct).div(hundred);
        const formatted = formatUnitsSafe(amountBn, TOKEN_DECIMALS);

        amountInput.value = formatted;
        updateEstimate();
      }

      function bootstrap() {
        setWalletStatus(false);
        setNetworkStatus(false, "0x0", 0);
        setHelper("Connect your wallet to start.", "error");

        if (!window.ethereum) {
          setHelper(
            "No wallet provider detected. Open this page inside MetaMask or Trust Wallet browser.",
            "error"
          );
        }
      }

      // ==== Events ====
      btnConnect.addEventListener("click", () => {
        connectWallet();
      });

      btnDisconnect.addEventListener("click", () => {
        disconnectWallet();
      });

      btnSell.addEventListener("click", () => {
        handleSell();
      });

      amountInput.addEventListener("input", () => {
        clearPercentSelection();
        updateEstimate();
      });

      percentButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const pct = Number(btn.dataset.percent || "0");
          if (pct > 0) {
            handlePercentClick(pct);
          }
        });
      });

      // ==== Init ====
      bootstrap();
    </script>
  </body>
</html>
